name: CI

on:
  push:
    branches:
      - main
      - 'feature/*'
    paths:
      - '**'
      - '!docs/**'

  pull_request:
    branches:
      - main
    paths:
      - '**'
      - '!docs/**'

  
jobs:
  build:
    name: Build & Package
    runs-on: ubuntu-latest
    steps:
      - name: Fetch all history for all tags and branches
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: | 
            6.0.x

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0
        with:
          versionSpec: '5.1.x'
          
      - name: Determine Version
        id:   gitversion
        uses: gittools/actions/gitversion/execute@v0
        
      - name: Display GitVersion outputs (step output)
        run: |
          echo "Major: ${{ steps.gitversion.outputs.major }}"
          echo "Minor: ${{ steps.gitversion.outputs.minor }}"
          echo "NuGetVersionV2: ${{ steps.gitversion.outputs.nuGetVersionV2 }}"
          echo "NuGetVersion: ${{ steps.gitversion.outputs.nuGetVersion }}"
          
      - name: Package release
        id: package_release
        run: |
          OUTPUT=${{ runner.temp }}/nupkgs
          dotnet build --configuration Release
          dotnet pack --configuration Release /p:Version=$VERSION /p:PackageOutputPath=$OUTPUT
          
      - name: 'Upload nuget packages'
        uses: actions/upload-artifact@v3
        with:
          name: dotnet_tools
          path: ${{ github.workspace }}/artifacts/
          
  release:
    name: Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Download native macos packages
      uses: actions/download-artifact@v3
      with:
        name: native-macOS
        path: ${{ github.workspace }}/artifacts/packages/native
